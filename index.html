<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>A Band After Midnight - AR Bare Minimum Test</title>
    <style>
        body { margin: 0; font-family: sans-serif; overflow: hidden; background-color: #000; color: #fff; }
        #container { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
        #controls { display: none; /* Hide controls for this bare minimum test */ }
        #loadingMessage {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 1.5em; text-align: center;
            background: rgba(0,0,0,0.75); padding: 25px; border-radius: 10px;
            z-index: 200; display: none;
        }
        #startExperienceUI { /* ... same as before ... */ }
    </style>

    <script type="importmap">
    {
      "imports": {
        "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.151.0/three.module.min.js",
        "three/addons/": "https://unpkg.com/three@0.151.0/examples/jsm/",
        "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>
</head>
<body>
    <div id="startExperienceUI">
        <h2>Welcome to the AR Visualizer!</h2>
        <p>This is a bare minimum test to display a single cube on the target.</p>
        <button id="startArButton">Start AR Experience</button>
    </div>
    <div id="loadingMessage">Loading AR Experience...</div>
    <div id="controls"> <button id="btn-starfield">Star Field</button>
        <button id="btn-clouds">Clouds</button>
        <button id="btn-water">Flowing Water</button>
        <button id="btn-fireflies">Fireflies</button>
        <button id="btn-none">Clear Visuals</button>
    </div>
    <div id="container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Content Loaded. Setting up listeners.");
            const container = document.querySelector("#container");
            const loadingMessage = document.getElementById('loadingMessage');
            const startExperienceUI = document.getElementById('startExperienceUI');
            const startArButton = document.getElementById('startArButton');

            let mindarThree;
            let anchor;
            let debugCube = null; // Only one visual for this test

            const initMindAR = async () => {
                console.log("initMindAR: Called.");
                if(loadingMessage) loadingMessage.style.display = 'block';
                if(loadingMessage) loadingMessage.innerHTML = "Initializing AR...<br>Please allow camera access.";
                
                // Basic audio setup for completeness, though not used for the cube
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    console.log("initMindAR: Microphone access granted (or already had it).");
                } catch (err) {
                    console.warn("initMindAR: Microphone access denied/error:", err.message);
                }

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.error("CRITICAL: getUserMedia not supported on this browser!");
                    if(loadingMessage) loadingMessage.innerHTML = "Camera access not supported on this browser.";
                    return;
                }

                try {
                    mindarThree = new MindARThree({
                        container: container,
                        imageTargetSrc: "./targets.mind", // CRITICAL: Ensure this path is correct!
                        maxTrack: 1,
                        uiLoading: "no", uiScanning: "no", uiError: "yes" // Show MindAR's own errors if any
                    });
                    console.log("initMindAR: MindARThree instance created.");

                    const { renderer, scene, camera } = mindarThree;
                    anchor = mindarThree.addAnchor(0);
                    console.log("initMindAR: Anchor created. Anchor object:", anchor);
                    if (!anchor || !anchor.group) {
                        console.error("CRITICAL: Failed to create anchor or anchor.group!");
                        if(loadingMessage) loadingMessage.innerHTML = "Error: Failed to create AR anchor.";
                        return;
                    }

                    anchor.onTargetFound = () => {
                        console.log("EVENT: Target Found!");
                        if(loadingMessage) loadingMessage.style.display = 'none';

                        if (debugCube) {
                            console.log("Target Found: Debug cube already exists. Making visible if needed.");
                            debugCube.visible = true;
                        } else {
                            console.log("Target Found: Creating debug cube...");
                            const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3); // Size 0.3
                            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true }); // Bright green wireframe
                            debugCube = new THREE.Mesh(geometry, material);
                            debugCube.position.set(0, 0.15, 0); // Position slightly above the target center

                            if (anchor && anchor.group) {
                                anchor.group.add(debugCube);
                                console.log("Target Found: Debug cube ADDED to anchor.group. Position:", debugCube.position);
                            } else {
                                console.error("Target Found: Cannot add debug cube, anchor or anchor.group is invalid!");
                            }
                        }
                    };

                    anchor.onTargetLost = () => {
                        console.log("EVENT: Target Lost.");
                        if (debugCube) {
                            console.log("Target Lost: Hiding debug cube.");
                            // Instead of removing, just hide it to simplify logic for now
                            // If you want to remove:
                            // if (anchor && anchor.group) anchor.group.remove(debugCube);
                            // debugCube = null;
                            debugCube.visible = false;
                        }
                    };

                    console.log("initMindAR: Attempting mindarThree.start()...");
                    await mindarThree.start(); 
                    console.log("initMindAR: mindarThree.start() successful. Renderer animation loop starting.");
                    if(loadingMessage) loadingMessage.innerHTML = "Scanning for target...";


                    renderer.setAnimationLoop(() => {
                        if (!renderer || !scene || !camera) {
                            console.error("Render loop: Renderer, scene, or camera is missing!");
                            return;
                        }
                        renderer.render(scene, camera);
                    });

                } catch (e) {
                    console.error("CRITICAL Error during MindAR initialization or start:", e);
                    if(loadingMessage) loadingMessage.innerHTML = "Critical Error starting AR. Check console.<br><small>" + e.message + "</small>";
                }
            };

            const beginARExperience = () => {
                console.log("UI: 'Start AR Experience' button clicked.");
                if (startExperienceUI) startExperienceUI.style.display = 'none';
                if (loadingMessage) loadingMessage.style.display = 'block';
                
                // Call initMindAR directly. No loadAllAssets for this bare minimum test.
                initMindAR().catch(err => {
                     console.error("CRITICAL: initMindAR promise rejected:", err);
                     if(loadingMessage) loadingMessage.innerHTML = "Failed to initialize AR. Check console.<br><small>" + err.message + "</small>";
                });
            };

            if (startArButton) {
                console.log("Adding click listener to 'Start AR' button.");
                startArButton.addEventListener('click', beginARExperience);
            } else {
                console.error("CRITICAL: Start AR Button not found in DOM!");
                if(loadingMessage) { 
                    loadingMessage.innerHTML = "Error: Start button missing. Cannot initialize.";
                    loadingMessage.style.display = 'block'; 
                }
            }
        });
    </script>
</body>
</html>
